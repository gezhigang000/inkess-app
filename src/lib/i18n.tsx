import { createContext, useContext, useState, useCallback, useEffect, type ReactNode } from 'react'
import { saveSettings, loadSettings } from './tauri'

export type Language = 'zh' | 'en'

const dict: Record<string, { zh: string; en: string }> = {
  // Toolbar
  'toolbar.open': { zh: '打开 (⌘O)', en: 'Open (⌘O)' },
  'toolbar.open.label': { zh: '打开', en: 'Open' },
  'toolbar.edit': { zh: '编辑', en: 'Edit' },
  'toolbar.read': { zh: '阅读', en: 'Read' },
  'toolbar.export': { zh: '导出', en: 'Export' },
  'toolbar.settings': { zh: '设置', en: 'Settings' },
  'toolbar.toggleSidebar': { zh: '切换侧边栏', en: 'Toggle Sidebar' },
  'toolbar.readOnly': { zh: '只读', en: 'Read-only' },
  'toolbar.backToLatest': { zh: '返回当前版本', en: 'Back to Latest' },
  'toolbar.editMode': { zh: '切换到编辑模式', en: 'Switch to Edit' },
  'toolbar.readMode': { zh: '切换到阅读模式', en: 'Switch to Read' },
  'toolbar.exportAs': { zh: '导出为 {fmt}', en: 'Export as {fmt}' },
  'toolbar.ai': { zh: 'AI 助手', en: 'AI Assistant' },
  'toolbar.devMode': { zh: '开发者模式 (⌘D)', en: 'Developer Mode (⌘D)' },
  'toolbar.cycleTheme': { zh: '切换主题', en: 'Switch Theme' },
  // Sidebar
  'sidebar.files': { zh: '文件', en: 'Files' },
  'sidebar.fileBrowser': { zh: '文件浏览器', en: 'File Browser' },
  'sidebar.empty': { zh: '拖入文件或按 Cmd+O 打开', en: 'Drop files or press Cmd+O' },
  'sidebar.noSupported': { zh: '此目录没有支持的文件', en: 'No supported files here' },
  'sidebar.depthLimit': { zh: '嵌套层级过深，无法继续展开', en: 'Nesting too deep, cannot expand further' },
  'sidebar.truncated': { zh: '还有 {n} 个未显示，建议使用搜索', en: '{n} more items not shown, use search' },
  'sidebar.largeDirWarn': { zh: '该目录包含大量文件，展开可能影响性能', en: 'This directory contains many files, expanding may affect performance' },
  'sidebar.loadFailed': { zh: '加载目录失败', en: 'Failed to load directory' },
  // WelcomeScreen
  'welcome.tagline': { zh: '简单，有序', en: 'Simple, organized' },
  'welcome.recent': { zh: '最近打开', en: 'Recent' },
  'welcome.emptyHint': { zh: '打开一个文件夹开始使用', en: 'Open a folder to get started' },
  'welcome.openFolder': { zh: '打开文件夹', en: 'Open Folder' },
  'welcome.quickOpen': { zh: '或按 <kbd>⌘ O</kbd> 快速打开', en: 'or press <kbd>⌘ O</kbd> to quick open' },
  // Timeline
  'timeline.label': { zh: '版本', en: 'Versions' },
  'timeline.nav': { zh: '版本时间线', en: 'Version Timeline' },
  'timeline.noRecords': { zh: '暂无版本记录', en: 'No version history' },
  'timeline.current': { zh: '当前版本', en: 'Current' },
  'timeline.history': { zh: '历史版本', en: 'History' },
  'timeline.snapshots': { zh: '{count} 个快照', en: '{count} snapshots' },
  'timeline.more': { zh: '+{count} 更多', en: '+{count} more' },
  'timeline.notSupported': { zh: '此文件类型不支持版本历史', en: 'Version history not supported for this file type' },
  'time.justNow': { zh: '刚刚', en: 'Just now' },
  'time.minutesAgo': { zh: '{n}分钟前', en: '{n}m ago' },
  'time.hoursAgo': { zh: '{n}小时前', en: '{n}h ago' },
  'time.daysAgo': { zh: '{n}天前', en: '{n}d ago' },
  'time.unknown': { zh: '未知时间', en: 'Unknown' },
  // ContentArea
  'content.switchToRead': { zh: '切换到阅读模式', en: 'Switch to Read Mode' },
  'content.switchToEdit': { zh: '切换到编辑模式', en: 'Switch to Edit Mode' },
  'content.formatMd': { zh: '格式化 Markdown', en: 'Format Markdown' },
  'content.exportAs': { zh: '导出为 {fmt}', en: 'Export as {fmt}' },
  'content.source': { zh: '源码', en: 'Source' },
  'content.preview': { zh: '预览', en: 'Preview' },
  // NewFilePopup
  'newFile.title': { zh: '新建文件', en: 'New File' },
  'newFolder.title': { zh: '新建文件夹', en: 'New Folder' },
  'newFile.emptyFile': { zh: '空文件', en: 'Empty File' },
  'newFile.placeholder.file': { zh: '文件名', en: 'File name' },
  'newFile.placeholder.folder': { zh: '文件夹名', en: 'Folder name' },
  'newFile.cancel': { zh: '取消', en: 'Cancel' },
  'newFile.create': { zh: '创建', en: 'Create' },
  // ConflictDialog
  'conflict.title': { zh: '文件已被外部修改', en: 'File Modified Externally' },
  'conflict.message': { zh: '文件 {name} 已在外部被修改，但你有未保存的更改。', en: 'File {name} was modified externally, but you have unsaved changes.' },
  'conflict.keepMine': { zh: '保留我的修改', en: 'Keep My Changes' },
  'conflict.acceptExternal': { zh: '加载外部版本', en: 'Load External Version' },
  'conflict.later': { zh: '稍后处理', en: 'Decide Later' },
  // SearchBar
  'search.title': { zh: '搜索文件', en: 'Search Files' },
  'search.placeholder': { zh: '输入文件名搜索...', en: 'Search files...' },
  'search.noResults': { zh: '无匹配结果', en: 'No results' },
  'search.inDoc': { zh: '文档内搜索', en: 'Find in document' },
  'search.inDocPlaceholder': { zh: '搜索...', en: 'Find...' },
  'search.matchCount': { zh: '{current}/{total}', en: '{current}/{total}' },
  'search.noMatch': { zh: '无匹配', en: 'No matches' },
  // SidebarContextMenu
  'ctx.newFile': { zh: '新建文件', en: 'New File' },
  'ctx.newFolder': { zh: '新建文件夹', en: 'New Folder' },
  'ctx.rename': { zh: '重命名', en: 'Rename' },
  'ctx.moveToTrash': { zh: '移到废纸篓', en: 'Move to Trash' },
  'ctx.gitOps': { zh: 'Git 操作', en: 'Git Operations' },
  'ctx.gitInit': { zh: '初始化 Git 仓库 ({dir})', en: 'Init Git Repo ({dir})' },
  'ctx.openInTerminal': { zh: '在终端中打开', en: 'Open in Terminal' },
  'ctx.copyPath': { zh: '复制路径', en: 'Copy Path' },
  'ctx.changes': { zh: '{n} 项变更', en: '{n} changes' },
  // GitPanel
  'git.title': { zh: 'Git', en: 'Git' },
  'git.notInit': { zh: '此目录尚未初始化 Git 仓库', en: 'Git not initialized in this directory' },
  'git.initRepo': { zh: '初始化 Git 仓库', en: 'Initialize Git Repo' },
  'git.configRemote': { zh: '+ 配置远程仓库', en: '+ Configure Remote' },
  'git.repoInited': { zh: 'Git 仓库已初始化', en: 'Git repo initialized' },
  'git.committed': { zh: '已提交', en: 'Committed' },
  'git.pushed': { zh: '已推送', en: 'Pushed' },
  'git.pulled': { zh: '已拉取', en: 'Pulled' },
  'git.remoteAdded': { zh: '远程仓库已添加', en: 'Remote added' },
  'git.sshGenerated': { zh: 'SSH Key 已生成', en: 'SSH Key generated' },
  'git.initFailed': { zh: '初始化失败', en: 'Init failed' },
  'git.opFailed': { zh: '操作失败', en: 'Operation failed' },
  'git.commitFailed': { zh: '提交失败', en: 'Commit failed' },
  'git.pushFailed': { zh: '推送失败', en: 'Push failed' },
  'git.pullFailed': { zh: '拉取失败', en: 'Pull failed' },
  'git.addFailed': { zh: '添加失败', en: 'Add failed' },
  'git.genFailed': { zh: '生成失败', en: 'Generation failed' },
  // AIChatPanel
  'ai.title': { zh: 'AI 助手', en: 'AI Assistant' },
  'ai.memories': { zh: '{n} 记忆', en: '{n} memories' },
  'ai.clearChat': { zh: '清空对话', en: 'Clear Chat' },
  'ai.newChat': { zh: '新建对话', en: 'New Chat' },
  'ai.chatHistory': { zh: '历史记录', en: 'Chat History' },
  'ai.noHistory': { zh: '暂无历史记录', en: 'No chat history' },
  'ai.historyMessages': { zh: '条消息', en: 'messages' },
  'ai.deleteSession': { zh: '删除此记录', en: 'Delete this session' },
  'ai.modelSettings': { zh: '模型设置', en: 'Model Settings' },
  'ai.close': { zh: '关闭', en: 'Close' },
  'ai.startChat': { zh: '输入消息开始对话', en: 'Type a message to start' },
  'ai.configModel': { zh: '配置 AI 模型', en: 'Configure AI Model' },
  'ai.toolCall': { zh: '调用', en: 'Calling' },
  'ai.toolResult': { zh: '{name} 结果', en: '{name} result' },
  'ai.inputPlaceholder': { zh: '输入消息... (Enter 发送)', en: 'Type a message... (Enter to send)' },
  'ai.configFirst': { zh: '请先配置 AI 模型', en: 'Configure AI model first' },
  'ai.sendMsg': { zh: '发送消息', en: 'Send Message' },
  'ai.requestFailed': { zh: 'AI 请求失败', en: 'AI request failed' },
  'ai.pythonSetup.downloading': { zh: '正在下载 Python 运行时...', en: 'Downloading Python runtime...' },
  'ai.pythonSetup.extracting': { zh: '正在解压 Python 运行时...', en: 'Extracting Python runtime...' },
  'ai.pythonSetup.installingPackages': { zh: '正在安装科学计算包...', en: 'Installing scientific packages...' },
  'ai.pythonSetup.done': { zh: 'Python 环境安装完成', en: 'Python environment ready' },
  'ai.pythonSetup.error': { zh: 'Python 环境安装失败', en: 'Python setup failed' },
  'ai.pythonSetup.preparing': { zh: '正在准备 Python 环境...', en: 'Preparing Python environment...' },
  'ai.deepMode': { zh: '深度思考', en: 'Deep Think' },
  'ai.deepModeOn': { zh: '深度思考模式已开启', en: 'Deep thinking mode enabled' },
  'ai.deepModeOff': { zh: '深度思考模式已关闭', en: 'Deep thinking mode disabled' },
  'ai.noWorkspace': { zh: '请先打开一个目录作为工作区', en: 'Please open a directory as workspace first' },
  'ai.currentWorkspace': { zh: '工作区: {dir}', en: 'Workspace: {dir}' },
  'toolbar.needWorkspace': { zh: '请先打开工作目录', en: 'Open a workspace first' },
  // AIModelConfig
  'aiConfig.title': { zh: 'AI 模型配置', en: 'AI Model Config' },
  'aiConfig.custom': { zh: '自定义', en: 'Custom' },
  'aiConfig.apiUrl': { zh: 'API 地址', en: 'API URL' },
  'aiConfig.apiKey': { zh: 'API Key', en: 'API Key' },
  'aiConfig.modelName': { zh: '模型名称', en: 'Model Name' },
  'aiConfig.advanced': { zh: '高级设置', en: 'Advanced' },
  'aiConfig.maxTokens': { zh: '最大 Token', en: 'Max Tokens' },
  'aiConfig.basePrompt': { zh: '基础提示词', en: 'Base Prompt' },
  'aiConfig.basePromptHint': { zh: '定义 AI 的工作方式和输出规则', en: 'Define AI workflow and output rules' },
  'aiConfig.systemPrompt': { zh: '角色提示词', en: 'Role Prompt' },
  'aiConfig.systemPromptHint': { zh: '设定 AI 的角色、风格和偏好（可选）', en: 'Set AI role, style and preferences (optional)' },
  'aiConfig.systemPromptPlaceholder': { zh: '例如：你是一个资深前端工程师，擅长 React 和 TypeScript，回复简洁直接。', en: 'e.g. You are a senior frontend engineer skilled in React and TypeScript.' },
  'aiConfig.test': { zh: '测试连接', en: 'Test Connection' },
  'aiConfig.testing': { zh: '测试中...', en: 'Testing...' },
  'aiConfig.save': { zh: '保存', en: 'Save' },
  'aiConfig.fillRequired': { zh: '请填写 API 地址和 Key', en: 'Please fill in API URL and Key' },
  'aiConfig.fillAll': { zh: '请填写完整配置', en: 'Please fill in all fields' },
  'aiConfig.saved': { zh: '配置已保存', en: 'Config saved' },
  'aiConfig.connFailed': { zh: '连接失败', en: 'Connection failed' },
  'aiConfig.saveFailed': { zh: '保存失败', en: 'Save failed' },
  'aiConfig.modelSection': { zh: '模型配置', en: 'Model Settings' },
  'aiConfig.sharedSection': { zh: '提示词', en: 'Prompts' },
  // App toasts
  'toast.created': { zh: '已创建: {name}', en: 'Created: {name}' },
  'toast.createdFolder': { zh: '已创建文件夹: {name}', en: 'Created folder: {name}' },
  'toast.createFailed': { zh: '创建失败', en: 'Create failed' },
  'toast.renamed': { zh: '已重命名', en: 'Renamed' },
  'toast.renameFailed': { zh: '重命名失败', en: 'Rename failed' },
  'toast.movedToTrash': { zh: '已移到废纸篓', en: 'Moved to Trash' },
  'toast.deleteFailed': { zh: '删除失败', en: 'Delete failed' },
  'toast.copiedPath': { zh: '已复制路径', en: 'Path copied' },
  'toast.saved': { zh: '已保存', en: 'Saved' },
  'toast.saveFailed': { zh: '保存失败，请检查文件权限', en: 'Save failed, check file permissions' },
  'toast.autoSaveFailed': { zh: '切换前自动保存失败', en: 'Auto-save failed before switching' },
  'toast.unsupported': { zh: '不支持的文件格式', en: 'Unsupported file format' },
  'toast.openFailed': { zh: '无法打开文件，请检查路径是否正确', en: 'Cannot open file, check the path' },
  'toast.largeFile': { zh: '此文件较大（{size}MB），打开可能较慢。是否继续？', en: 'This file is large ({size}MB) and may be slow to open. Continue?' },
  'toast.openFirst': { zh: '请先打开一个文件', en: 'Open a file first' },
  'toast.exportFailed': { zh: '导出失败，请重试', en: 'Export failed, please retry' },
  'toast.exportNotSupported': { zh: '当前文件类型不支持导出', en: 'Export not supported for this file type' },
  'toast.loadHistoryFailed': { zh: '无法加载历史版本', en: 'Cannot load history version' },
  'toast.loadExternalFailed': { zh: '加载外部版本失败', en: 'Failed to load external version' },
  'toast.readFailed': { zh: '无法读取文件', en: 'Cannot read file' },
  'toast.opened': { zh: '已打开: {name}（只读）', en: 'Opened: {name} (read-only)' },
  'toast.theme': { zh: '主题: {name}', en: 'Theme: {name}' },
  'toast.gitInited': { zh: 'Git 仓库已初始化', en: 'Git repo initialized' },
  'toast.gitInitFailed': { zh: 'Git 初始化失败', en: 'Git init failed' },
  'toast.dragHint': { zh: '拖放文件到此处', en: 'Drop files here' },
  'toast.switchDirConfirm': { zh: '切换工作区到 {dir}？', en: 'Switch workspace to {dir}?' },
  // Settings
  'settings.title': { zh: '设置', en: 'Settings' },
  'settings.tab.appearance': { zh: '外观', en: 'Appearance' },
  'settings.tab.data': { zh: '数据', en: 'Data' },
  'settings.tab.mcp': { zh: 'MCP', en: 'MCP' },
  'settings.tab.license': { zh: '许可证', en: 'License' },
  'settings.appearance': { zh: '外观', en: 'Appearance' },
  'settings.theme': { zh: '主题', en: 'Theme' },
  'settings.language': { zh: '语言', en: 'Language' },
  'settings.dataManagement': { zh: '数据管理', en: 'Data Management' },
  'settings.snapshotStats': { zh: '快照统计', en: 'Snapshot Stats' },
  'settings.snapshotCount': { zh: '{count} 个快照，{size}', en: '{count} snapshots, {size}' },
  'settings.retentionDays': { zh: '保留天数', en: 'Retention Days' },
  'settings.retentionCount': { zh: '每文件保留', en: 'Per-file Retention' },
  'settings.cleanupNow': { zh: '立即清理', en: 'Clean Up Now' },
  'settings.cleaning': { zh: '清理中...', en: 'Cleaning...' },
  'settings.save': { zh: '保存', en: 'Save' },
  'settings.cleanupDone': { zh: '已清理 {n} 个快照', en: 'Cleaned up {n} snapshots' },
  'settings.settingsSaved': { zh: '设置已保存', en: 'Settings saved' },
  'settings.loading': { zh: '加载中...', en: 'Loading...' },
  // RAG Knowledge Base
  'rag.status.indexing': { zh: '索引中...', en: 'Indexing...' },
  'rag.status.ready': { zh: '知识库就绪', en: 'Knowledge base ready' },
  'rag.status.error': { zh: '索引失败', en: 'Index failed' },
  'rag.status.disabled': { zh: '知识库未启用', en: 'Knowledge base disabled' },
  'rag.stats': { zh: '{files} 文件, {chunks} 块, {size}', en: '{files} files, {chunks} chunks, {size}' },
  'rag.knowledgeBase': { zh: '知识库', en: 'Knowledge Base' },
  'rag.rebuild': { zh: '重建索引', en: 'Rebuild Index' },
  'rag.rebuilding': { zh: '重建中...', en: 'Rebuilding...' },
  'rag.clearIndex': { zh: '清除索引', en: 'Clear Index' },
  'rag.cleared': { zh: '索引已清除', en: 'Index cleared' },
  'rag.rebuildDone': { zh: '索引重建完成', en: 'Index rebuilt' },
  'rag.initFailed': { zh: '知识库初始化失败', en: 'Knowledge base init failed' },
  'rag.modelDownloading': { zh: '下载嵌入模型...', en: 'Downloading embedding model...' },
  'rag.tooltip.files': { zh: '文件数: {n}', en: 'Files: {n}' },
  'rag.tooltip.chunks': { zh: '块数: {n}', en: 'Chunks: {n}' },
  'rag.tooltip.size': { zh: '数据库大小: {size}', en: 'DB size: {size}' },
  'rag.tooltip.indexing': { zh: '正在索引...', en: 'Indexing...' },
  // Model download progress
  'ai.downloadingModel': { zh: '下载模型中...', en: 'Downloading model...' },
  'ai.downloadingTokenizer': { zh: '下载分词器中...', en: 'Downloading tokenizer...' },
  'ai.loadingModel': { zh: '加载模型中...', en: 'Loading model...' },
  // MCP Servers
  'mcp.title': { zh: 'MCP Servers', en: 'MCP Servers' },
  'mcp.addServer': { zh: '添加 Server', en: 'Add Server' },
  'mcp.name': { zh: '名称', en: 'Name' },
  'mcp.command': { zh: '命令', en: 'Command' },
  'mcp.args': { zh: '参数', en: 'Args' },
  'mcp.env': { zh: '环境变量', en: 'Env' },
  'mcp.envHint': { zh: 'KEY=VALUE, 每行一个', en: 'KEY=VALUE, one per line' },
  'mcp.restart': { zh: '重启', en: 'Restart' },
  'mcp.remove': { zh: '移除', en: 'Remove' },
  'mcp.connected': { zh: '已连接', en: 'Connected' },
  'mcp.disconnected': { zh: '未连接', en: 'Disconnected' },
  'mcp.error': { zh: '错误', en: 'Error' },
  'mcp.tools': { zh: '{n} 个工具', en: '{n} tools' },
  'mcp.cancel': { zh: '取消', en: 'Cancel' },
  'mcp.add': { zh: '添加', en: 'Add' },
  'mcp.addSuccess': { zh: 'MCP Server 已添加', en: 'MCP server added' },
  'mcp.addFailed': { zh: '添加失败', en: 'Add failed' },
  'mcp.removeFailed': { zh: '移除失败', en: 'Remove failed' },
  'mcp.restartFailed': { zh: '重启失败', en: 'Restart failed' },
  // MCP reconnect
  'mcp.reconnecting': { zh: '重连中...', en: 'Reconnecting...' },
  'mcp.reconnected': { zh: '已重连', en: 'Reconnected' },
  'mcp.reconnectFailed': { zh: '重连失败', en: 'Reconnect failed' },
  // MCP transport
  'mcp.transport': { zh: '传输方式', en: 'Transport' },
  'mcp.url': { zh: 'URL', en: 'URL' },
  'mcp.urlHint': { zh: 'HTTP 服务器地址', en: 'HTTP server URL' },
  'mcp.lastSeen': { zh: '最后响应: {time}', en: 'Last seen: {time}' },
  'mcp.secondsAgo': { zh: '{n}秒前', en: '{n}s ago' },
  'mcp.minutesAgo': { zh: '{n}分钟前', en: '{n}m ago' },
  'mcp.healthOk': { zh: '健康', en: 'Healthy' },
  'mcp.healthDead': { zh: '无响应', en: 'No response' },
  // MCP templates
  'mcp.template': { zh: '从模板创建', en: 'From template' },
  'mcp.selectTemplate': { zh: '选择模板...', en: 'Select template...' },
  // MCP tool logs
  'mcp.toolLogs': { zh: '调用日志', en: 'Tool Logs' },
  'mcp.toolLog.time': { zh: '时间', en: 'Time' },
  'mcp.toolLog.server': { zh: '服务器', en: 'Server' },
  'mcp.toolLog.tool': { zh: '工具', en: 'Tool' },
  'mcp.toolLog.duration': { zh: '耗时', en: 'Duration' },
  'mcp.toolLog.expand': { zh: '展开详情', en: 'Expand' },
  'mcp.toolLog.collapse': { zh: '收起', en: 'Collapse' },
  'mcp.toolLog.noLogs': { zh: '暂无调用记录', en: 'No tool calls yet' },
  // RAG document support
  'rag.pdfSupport': { zh: '支持 PDF 文件', en: 'PDF files supported' },
  'rag.docxSupport': { zh: '支持 Word 文件', en: 'Word files supported' },
  'rag.xlsxSupport': { zh: '支持 Excel 文件', en: 'Excel files supported' },
  // File reference link
  'ai.openFile': { zh: '打开文件', en: 'Open file' },
  // Git init confirm
  'gitInit.title': { zh: '初始化 Git 仓库', en: 'Initialize Git Repository' },
  'gitInit.message': { zh: '将在以下目录初始化 Git 仓库：', en: 'Initialize Git repository in:' },
  'gitInit.cancel': { zh: '取消', en: 'Cancel' },
  'gitInit.confirm': { zh: '确认初始化', en: 'Confirm Init' },
  // AI switch model
  'ai.switchModel': { zh: '切换模型', en: 'Switch Model' },
  'ai.keyNotConfigured': { zh: '未配置此服务商的 API Key，请先在设置中配置', en: 'API Key not configured for this provider. Please configure in settings first.' },
  'ai.workspaceSwitched': { zh: '工作目录已切换到 {dir}', en: 'Workspace switched to {dir}' },
  'ai.copyChat': { zh: '复制对话', en: 'Copy Conversation' },
  'ai.copiedChat': { zh: '对话已复制到剪贴板', en: 'Conversation copied to clipboard' },
  'ai.openPreview': { zh: '打开预览', en: 'Open Preview' },
  // AI config search key
  'aiConfig.searchApiKey': { zh: '搜索 API Key', en: 'Search API Key' },
  'aiConfig.searchApiKeyHint': { zh: '可选，配置后使用 Tavily 搜索', en: 'Optional, uses Tavily search when set' },
  'aiConfig.searchSection': { zh: '搜索', en: 'Search' },
  'aiConfig.searchProvider': { zh: '选择搜索引擎', en: 'Choose search engine' },
  // Git remote selector
  'git.selectRemote': { zh: '选择远程仓库', en: 'Select Remote' },
  // Theme names
  'theme.github': { zh: 'GitHub', en: 'GitHub' },
  'theme.minimal': { zh: '简约', en: 'Minimal' },
  'theme.dark': { zh: '暗色', en: 'Dark' },
  // License
  'license.title': { zh: 'License', en: 'License' },
  'license.free': { zh: 'Free 版', en: 'Free' },
  'license.pro': { zh: 'Pro 版', en: 'Pro' },
  'license.activated': { zh: '已激活', en: 'Activated' },
  'license.activate': { zh: '激活', en: 'Activate' },
  'license.activating': { zh: '激活中...', en: 'Activating...' },
  'license.deactivate': { zh: '取消激活', en: 'Deactivate' },
  'license.inputKey': { zh: '输入 License Key', en: 'Enter License Key' },
  'license.keyPlaceholder': { zh: 'INKESS-XXXX-XXXX-XXXX-XXXX', en: 'INKESS-XXXX-XXXX-XXXX-XXXX' },
  'license.buyPro': { zh: '购买 Pro', en: 'Buy Pro' },
  'license.activateSuccess': { zh: 'Pro 版已激活', en: 'Pro activated' },
  'license.activateFailed': { zh: '激活失败', en: 'Activation failed' },
  'license.deactivated': { zh: '已取消激活', en: 'Deactivated' },
  'license.upgrade': { zh: '升级 Pro', en: 'Upgrade to Pro' },
  'license.upgradeHint': { zh: '此功能需要 Pro 版', en: 'This feature requires Pro' },
  'update.available': { zh: '发现新版本 v{version}，是否立即更新？', en: 'New version v{version} available. Update now?' },
  'license.featureAI': { zh: 'AI 助手全功能：对话、Tool Use、记忆、联网搜索、Python 执行', en: 'Full AI assistant: chat, tool use, memory, web search, Python execution' },
  'license.featureTerminal': { zh: '内置终端：集成开发环境体验', en: 'Built-in terminal: integrated development experience' },
  'license.featureGit': { zh: 'Git 面板：版本控制可视化操作', en: 'Git panel: visual version control' },
  'license.featureExport': { zh: '导出无水印', en: 'Export without watermark' },
  'license.featureSnapshot': { zh: '无限版本快照', en: 'Unlimited version snapshots' },
  'license.compare': { zh: '功能对比', en: 'Compare Plans' },
  'license.feature': { zh: '功能', en: 'Feature' },
  'license.compareMarkdown': { zh: 'Markdown 渲染阅读', en: 'Markdown rendering' },
  'license.compareThemes': { zh: '3 套主题', en: '3 themes' },
  'license.compareEdit': { zh: '编辑 + 自动保存', en: 'Edit + auto-save' },
  'license.compareSidebar': { zh: '文件浏览 + 搜索', en: 'File browser + search' },
  'license.comparePreview': { zh: '多格式预览', en: 'Multi-format preview' },
  'license.compareI18n': { zh: '多语言', en: 'Multi-language' },
  'license.compareExport': { zh: '导出 PDF / Word / HTML', en: 'Export PDF / Word / HTML' },
  'license.compareWatermark': { zh: '导出无水印', en: 'Export without watermark' },
  'license.compareSnapshot': { zh: '版本快照', en: 'Version snapshots' },
  'license.compareSnapshotFree': { zh: '最近 10 个/文件', en: 'Last 10 per file' },
  'license.compareSnapshotPro': { zh: '无限', en: 'Unlimited' },
  'license.compareAI': { zh: 'AI 助手', en: 'AI Assistant' },
  'license.compareTerminal': { zh: '内置终端', en: 'Built-in terminal' },
  'license.compareGit': { zh: 'Git 面板', en: 'Git panel' },
  'license.compareFuture': { zh: '未来新功能', en: 'Future features' },
  'license.oneTime': { zh: '一次性买断', en: 'One-time purchase' },
  // Viewers
  'viewer.reset': { zh: '重置', en: 'Reset' },
  'viewer.prevPage': { zh: '上一页', en: 'Prev' },
  'viewer.nextPage': { zh: '下一页', en: 'Next' },
  'viewer.pdfLoadFailed': { zh: '无法加载 PDF 文件', en: 'Failed to load PDF' },
  'viewer.renderFailed': { zh: '渲染页面失败', en: 'Failed to render page' },
  'viewer.emptyWorkbook': { zh: '空的工作簿', en: 'Empty workbook' },
  // Git status
  'git.noChanges': { zh: '没有文件变更', en: 'No file changes' },
  'git.staged': { zh: '已暂存', en: 'Staged' },
  'git.unstaged': { zh: '未暂存', en: 'Unstaged' },
  'git.commitPlaceholder': { zh: '提交消息...', en: 'Commit message...' },
  // Git remote setup
  'gitRemote.title': { zh: '配置远程仓库', en: 'Configure Remote' },
  'gitRemote.close': { zh: '关闭', en: 'Close' },
  'gitRemote.custom': { zh: '自定义', en: 'Custom' },
  'gitRemote.repoUrl': { zh: '仓库 URL', en: 'Repository URL' },
  'gitRemote.showSsh': { zh: '配置 SSH Key', en: 'Configure SSH Key' },
  'gitRemote.hideSsh': { zh: '收起 SSH 配置', en: 'Hide SSH Config' },
  'gitRemote.emailPlaceholder': { zh: '邮箱地址', en: 'Email address' },
  'gitRemote.generateSsh': { zh: '生成 SSH Key', en: 'Generate SSH Key' },
  'gitRemote.copyPublicKey': { zh: '复制公钥', en: 'Copy Public Key' },
  'gitRemote.cancel': { zh: '取消', en: 'Cancel' },
  'gitRemote.addRemote': { zh: '添加远程仓库', en: 'Add Remote' },
  // Terminal
  'terminal.newTab': { zh: '新建终端', en: 'New Terminal' },
  'terminal.split': { zh: '分屏', en: 'Split' },
  'terminal.startFailed': { zh: '终端启动失败', en: 'Terminal start failed' },
  'terminal.processExited': { zh: '进程已退出', en: 'Process exited' },
  'terminal.history': { zh: '历史日志', en: 'History' },
  'terminal.fullscreen': { zh: '全屏', en: 'Fullscreen' },
  'terminal.noLogs': { zh: '暂无日志', en: 'No logs' },
  'terminal.recovered': { zh: '恢复', en: 'Recovered' },
  'terminal.provider': { zh: 'Provider', en: 'Provider' },
  'terminal.noProvider': { zh: '无 Provider', en: 'No Provider' },
  'terminal.colorScheme': { zh: '配色方案', en: 'Color Scheme' },
  'terminal.viewLog': { zh: '查看日志', en: 'View Log' },
  'terminal.deleteLog': { zh: '删除日志', en: 'Delete Log' },
  'terminal.copy': { zh: '复制', en: 'Copy' },
  'terminal.copied': { zh: '已复制', en: 'Copied' },
  'terminal.maxTabs': { zh: '已达最大终端数，请关闭一个后再切换', en: 'Max terminals reached, close one first' },
  // Settings — Providers tab
  'settings.tab.providers': { zh: '终端配置', en: 'Providers' },
  'providers.title': { zh: '终端 Provider', en: 'Terminal Providers' },
  'providers.add': { zh: '添加 Provider', en: 'Add Provider' },
  'providers.name': { zh: '名称', en: 'Name' },
  'providers.envVars': { zh: '环境变量', en: 'Environment Variables' },
  'providers.addVar': { zh: '添加变量', en: 'Add Variable' },
  'providers.importEnv': { zh: '从系统导入', en: 'Import from System' },
  'providers.importShell': { zh: '从 Shell 配置导入', en: 'Import from Shell' },
  'providers.key': { zh: '键', en: 'Key' },
  'providers.value': { zh: '值', en: 'Value' },
  'providers.default': { zh: '默认 Provider', en: 'Default Provider' },
  'providers.none': { zh: '无 Provider', en: 'No Provider' },
  'providers.confirm': { zh: '确认', en: 'Confirm' },
  'providers.cancel': { zh: '取消', en: 'Cancel' },
  'providers.saved': { zh: 'Provider 已保存', en: 'Providers saved' },
  'providers.manage': { zh: '管理 Provider...', en: 'Manage Providers...' },
  'providers.deleteConfirm': { zh: '删除此 Provider？', en: 'Delete this provider?' },
  'providers.importRC': { zh: '从 Shell 函数导入', en: 'Import from Shell RC' },
  'providers.importRCTitle': { zh: '选择要导入的 Shell 函数', en: 'Shell functions found' },
  'providers.noFunctions': { zh: '未找到包含 export 的 Shell 函数', en: 'No shell functions with exports found' },
  'providers.import': { zh: '导入', en: 'Import' },
  // NewFilePopup
  'newFile.emptyFileLabel': { zh: '空文件', en: 'Empty File' },
  'newFile.newDoc': { zh: '新文档', en: 'New Document' },
  // About / Shortcuts dialog
  'about.title': { zh: '关于 Inkess', en: 'About Inkess' },
  'about.tagline': { zh: '简单，有序', en: 'Simple, organized' },
  'about.website': { zh: '官网', en: 'Website' },
  'about.feedback': { zh: '反馈', en: 'Feedback' },
  'about.shortcuts': { zh: '快捷键', en: 'Keyboard Shortcuts' },
  'about.shortcut.open': { zh: '打开文件/目录', en: 'Open file/folder' },
  'about.shortcut.edit': { zh: '切换编辑模式', en: 'Toggle edit mode' },
  'about.shortcut.save': { zh: '保存', en: 'Save' },
  'about.shortcut.find': { zh: '文档内搜索', en: 'Find in document' },
  'about.shortcut.export': { zh: '快速导出 PDF', en: 'Quick export PDF' },
  'about.shortcut.devMode': { zh: '开发者模式', en: 'Developer mode' },
  'about.shortcut.terminal': { zh: '切换终端', en: 'Toggle terminal' },
  'about.shortcut.devConsole': { zh: '调试控制台', en: 'Debug console' },
  'about.shortcut.exitEdit': { zh: '退出编辑', en: 'Exit editing' },
  // Markdown Toolbar
  'mdToolbar.bold': { zh: '粗体', en: 'Bold' },
  'mdToolbar.italic': { zh: '斜体', en: 'Italic' },
  'mdToolbar.strikethrough': { zh: '删除线', en: 'Strikethrough' },
  'mdToolbar.code': { zh: '行内代码', en: 'Inline Code' },
  'mdToolbar.heading': { zh: '标题', en: 'Heading' },
  'mdToolbar.ul': { zh: '无序列表', en: 'Bullet List' },
  'mdToolbar.ol': { zh: '有序列表', en: 'Ordered List' },
  'mdToolbar.quote': { zh: '引用', en: 'Quote' },
  'mdToolbar.codeBlock': { zh: '代码块', en: 'Code Block' },
  'mdToolbar.hr': { zh: '分隔线', en: 'Horizontal Rule' },
  'mdToolbar.link': { zh: '链接', en: 'Link' },
  'mdToolbar.image': { zh: '图片', en: 'Image' },
  'mdToolbar.table': { zh: '表格', en: 'Table' },
  'mdToolbar.tableSize': { zh: '{cols} × {rows} 表格', en: '{cols} × {rows} table' },
  'mdToolbar.linkUrl': { zh: 'URL 地址', en: 'URL' },
  'mdToolbar.linkText': { zh: '显示文本', en: 'Display Text' },
  'mdToolbar.insert': { zh: '插入', en: 'Insert' },
  'mdToolbar.saveFirst': { zh: '请先保存文件', en: 'Please save the file first' },
}

interface I18nContextValue {
  lang: Language
  setLang: (lang: Language) => void
  t: (key: string, vars?: Record<string, string | number>) => string
}

const I18nContext = createContext<I18nContextValue>({
  lang: 'en',
  setLang: () => {},
  t: (key) => key,
})

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLangState] = useState<Language>(() =>
    (localStorage.getItem('inkess-language') as Language) || 'en'
  )
  // Load from settings.json on mount (overrides localStorage if present)
  useEffect(() => {
    loadSettings().then(s => {
      if (s.language === 'zh' || s.language === 'en') {
        setLangState(s.language)
        localStorage.setItem('inkess-language', s.language)
      }
    }).catch(() => {})
  }, [])
  const setLang = useCallback((l: Language) => {
    setLangState(l)
    localStorage.setItem('inkess-language', l)
    // Persist to settings.json
    loadSettings().then(s => saveSettings({ ...s, language: l })).catch(() => {})
  }, [])
  const t = useCallback((key: string, vars?: Record<string, string | number>) => {
    let text = dict[key]?.[lang] || key
    if (vars) {
      Object.entries(vars).forEach(([k, v]) => {
        text = text.replace(`{${k}}`, String(v))
      })
    }
    return text
  }, [lang])
  return (
    <I18nContext.Provider value={{ lang, setLang, t }}>
      {children}
    </I18nContext.Provider>
  )
}

export function useI18n() {
  return useContext(I18nContext)
}
